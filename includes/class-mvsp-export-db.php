<?php
	require_once plugin_dir_path(dirname(__FILE__)) . 'includes/class-mvsp-encryption.php';
	// require_once plugin_dir_path( __DIR__ ) . 'libs/updraftplus/updraftplus.php';

	class MVSP_Export_DB
	{
		public static function export_db()
		{
			require_once plugin_dir_path(dirname(__FILE__)) . 'libs/updraftplus/updraftplus.php';
			require_once plugin_dir_path(dirname(__FILE__)) . 'libs/updraftplus/backup.php';
			// require_once ABSPATH . 'wp-load.php';
			// global $wpdb;
			// $db_user = DB_USER;
			// $db_pass = DB_PASSWORD;
			// $db_name = DB_NAME;
			// $db_host = DB_HOST;

			$exported_db_filename = get_option('mvsp_auth_token');
			$exported_db_filename = substr($exported_db_filename, 0, 40);
			// // Create a connection to the database
			// $mysqli = new mysqli($db_host, $db_user, $db_pass, $db_name);

			// // Check the connection
			// if ($mysqli->connect_error) {
			// 	die('Connection failed: ' . $mysqli->connect_error);
			// }

			// // Output file name and path
			// $output_file = $exported_db_filename.'.txt';

			// // Open the output file for writing
			// $file = fopen($output_file, 'w');

			// // Write the SQL dump header
			// fwrite($file, "-- phpMyAdmin SQL Dump\n");
			// fwrite($file, "-- version 5.2.0\n");
			// fwrite($file, "-- https://www.phpmyadmin.net/\n");
			// fwrite($file, "--\n");
			// fwrite($file, "-- Host: $db_host\n");
			// fwrite($file, "-- Generation Time: " . date("M d, Y \a\\t H:i A") . "\n");
			// fwrite($file, "-- Server version: " . $mysqli->server_info . "\n");
			// fwrite($file, "-- PHP Version: " . phpversion() . "\n\n");

			// // Set SQL mode and start transaction
			// fwrite($file, "SET SQL_MODE = \"NO_AUTO_VALUE_ON_ZERO\";\n");
			// fwrite($file, "START TRANSACTION;\n");
			// fwrite($file, "SET time_zone = \"+00:00\";\n\n");

			// // Set character set settings
			// fwrite($file, "/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;\n");
			// fwrite($file, "/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;\n");
			// fwrite($file, "/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;\n");
			// fwrite($file, "/*!40101 SET NAMES utf8mb4 */;\n\n");

			// // Write database information
			// fwrite($file, "--\n-- Database: `$db_name`\n--\n\n");

			// // Iterate through each table and export structure and data
			// $result = $mysqli->query("SHOW TABLES");
			// while ($row = $result->fetch_row()) {
			// 	$table = $row[0];

			// 	// Export table structure
			// 	$result_structure = $mysqli->query("SHOW CREATE TABLE $table");
			// 	$table_structure = $result_structure->fetch_row()[1];
			// 	fwrite($file, "$table_structure;\n\n");

			// 	// Export table data
			// 	$result_data = $mysqli->query("SELECT * FROM $table");
			// 	while ($data_row = $result_data->fetch_assoc()) {
			// 		$values = array_map([$mysqli, 'real_escape_string'], array_values($data_row));
			// 		fwrite($file, "INSERT INTO $table VALUES ('" . implode("', '", $values) . "');\n");
			// 	}

			// 	fwrite($file, "\n");
			// }

			// // Close the output file and database connection
			// fclose($file);
			// $mysqli->close();

            // $sql_dump_file_path = ABSPATH . $output_file;
            // $sql_dump_content = file_get_contents($sql_dump_file_path);
            
            // // Check if the string exists in the file content
            // if (strpos($sql_dump_content, 'COLLATE=utf8mb4_unicode_520_ci') !== false) {
            //     // Perform the replacement
            //     $sql_dump_content = str_replace('COLLATE=utf8mb4_unicode_520_ci', 'COLLATE=utf8mb4_unicode_ci', $sql_dump_content);
            //     // Write the modified content back to the SQL dump file
            //     file_put_contents($sql_dump_file_path, $sql_dump_content);
            // }
            
			// return $output_file;


			$updraft_backup_obj = new UpdraftPlus_Backup('no', ABSPATH, $exported_db_filename, -1);
			return $updraft_backup_obj->backup_db();
		}

		public static function get_db_config()
		{
			require_once ABSPATH . 'wp-config.php';
			require_once ABSPATH . 'wp-load.php';
			global $wpdb;
			global $table_prefix;
			$db_user = DB_USER;
			$db_pass = DB_PASSWORD;
			$db_name = DB_NAME;
			$db_host = DB_HOST;
			$db_table_prefix = $table_prefix;
			$secure_auth_key = SECURE_AUTH_KEY;
			$logged_in_key = LOGGED_IN_KEY;
			$nonce_key = NONCE_KEY;
			$auth_salt_key = AUTH_SALT;
			$secure_auth_salt_key = SECURE_AUTH_SALT;
			$logged_in_salt_key = LOGGED_IN_SALT;
			$nonce_salt_key = NONCE_SALT;
			$wp_debug = WP_DEBUG;

			$exported_db_filename = get_option('mvsp_auth_token');

			$config_file = fopen($exported_db_filename . ".txt", "w") or die("Unable to open file!");
			$db_config = array(
				'db_user' => $db_user,
				'db_pass' => $db_pass,
				'db_name' => $db_name,
				'db_host' => $db_host,
				'db_table_prefix' => $db_table_prefix,
				'secure_auth_key' => $secure_auth_key,
				'logged_in_key' => $logged_in_key,
				'nonce_key' => $nonce_key,
				'auth_salt_key' => $auth_salt_key,
				'secure_auth_salt_key' => $secure_auth_salt_key,
				'logged_in_salt_key' => $logged_in_salt_key,
				'nonce_salt_key' => $nonce_salt_key,
				'wp_debug' => $wp_debug
			);
			fwrite($config_file, json_encode($db_config));
			fclose($config_file);

			return $exported_db_filename . '.txt';
		}
	}